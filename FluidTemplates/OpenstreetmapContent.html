<div xmlns:f="http://typo3.org/ns/TYPO3/Fluid/ViewHelpers" xmlns:flux="http://typo3.org/ns/FluidTYPO3/Flux/ViewHelpers" data-namespace-typo3-fluid="true">

	<f:layout name="Content"/>

	<f:section name="Configuration">
		<flux:form id="openstreetmap" label="OpenStreetMap Karte" description="Interaktive OpenStreetMap-Karte zur Anzeige einer Firmenadresse">
			<flux:form.option name="group" value="Content"/>
			<flux:form.option name="icon" value="EXT:template/Resources/Public/Icons/Content/content-openstreetmap.svg"/>

			<!-- Konfiguration Sheet -->
			<flux:form.sheet name="config" label="Konfiguration">
				<flux:field.input name="title" label="Titel" required="1" default=""/>
				<flux:field.input name="street" label="Strasse" required="1" default=""/>
				<flux:field.input name="zip" label="PLZ" required="1" default=""/>
				<flux:field.input name="city" label="Ort" required="1" default=""/>
				<flux:field.input name="lat" label="Breitengrad (Latitude)" default=""/>
				<flux:field.input name="lng" label="Längengrad (Longitude)" default=""/>
				<flux:field.input name="zoom" label="Zoom-Level (1-19)" default="15"/>
			</flux:form.sheet>

			<!-- Kartenstil Sheet -->
			<flux:form.sheet name="mapstyle" label="Kartenstil">
				<flux:field.select name="tileLayer" label="Karten-Anbieter" items="{
					osm: 'OpenStreetMap Standard',
					osm_de: 'OpenStreetMap Deutschland',
					topo: 'OpenTopoMap',
					cycle: 'OpenCycleMap'
				}" default="osm"/>
				<flux:field.input name="aspectRatio" label="Seitenverhältnis (z.B. 16-9, 4-3, 3-2)" default="16-9" placeholder="16-9"/>
				<flux:field.checkbox name="grayscale" label="Graustufen Anzeige" default="0"/>
			</flux:form.sheet>

			<!-- Routen-Link Sheet -->
			<flux:form.sheet name="route" label="Routen-Link">
				<flux:field.checkbox name="showRouteLink" label="Routen-Link anzeigen" default="1"/>
				<flux:field.select name="routeProvider" label="Routen-Anbieter" items="{
					osm: 'OpenStreetMap',
					google: 'Google Maps'
				}" default="osm"/>
				<flux:field.input name="routeLinkText" label="Link-Text" default="Route berechnen"/>
			</flux:form.sheet>
		</flux:form>
	</f:section>

	<f:section name="Preview">
		<strong>OpenStreetMap</strong><br/>
		<f:if condition="{title}">
			<strong>Titel:</strong> {title}<br/>
		</f:if>
		<strong>Adresse:</strong> {street}, {zip} {city}<br/>
		<f:if condition="{aspectRatio}">
			<strong>Seitenverhältnis:</strong> {aspectRatio}<br/>
		</f:if>
	</f:section>

	<f:section name="Main">
		<!-- Leaflet CSS via CDN -->
		<v:asset.style path="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" external="1"/>

		<f:variable name="mapId" value="osm-map-{record.uid}"/>

		<!-- CSS for aspect-ratio and map container -->
		<f:if condition="{aspectRatio}">
			<style>
				[data-osm-map-uid="<f:format.raw>{record.uid}</f:format.raw>"] {
					aspect-ratio: <f:format.raw>{aspectRatio -> v:format.replace(substring: '-', replacement: '/')}</f:format.raw>;
				}
			</style>
		</f:if>

		<div class="content-openstreet-map"
			 data-osm-map-uid="{record.uid}"
			 id="{mapId}"
			 data-controller="openstreetmap-content"
			 data-openstreetmap-content-lat-value="{lat}"
			 data-openstreetmap-content-lng-value="{lng}"
			 data-openstreetmap-content-zoom-value="{zoom}"
			 data-openstreetmap-content-tile-layer-value="{tileLayer}"
			 data-openstreetmap-content-grayscale-value="{grayscale}">

			<!-- Map Container -->
			<div class="content-openstreet-map__map" data-openstreetmap-content-target="map"></div>

			<!-- Left Overlay with Address -->
			<div class="content-openstreet-map__overlay">
				<div class="content-openstreet-map__address-card">
					<f:if condition="{title}">
						<h3 class="content-openstreet-map__title">{title}</h3>
					</f:if>

					<address class="content-openstreet-map__address">
						{street}<br/>
						{zip} {city}
					</address>

					<!-- Route Link -->
					<f:if condition="{showRouteLink}">
						<f:if condition="{routeProvider} == 'osm'">
							<f:then>
								<a href="https://www.openstreetmap.org/directions?from=&to={street}, {zip} {city}" target="_blank" rel="noopener noreferrer" class="button button--primary content-openstreet-map__route-link">
									<f:if condition="{routeLinkText}">
										<f:then>{routeLinkText}</f:then>
										<f:else>Route berechnen</f:else>
									</f:if>
								</a>
							</f:then>
						</f:if>
						<f:if condition="{routeProvider} == 'google'">
							<f:then>
								<a href="https://www.google.com/maps/dir/?api=1&destination={street}, {zip} {city}" target="_blank" rel="noopener noreferrer" class="button button--primary content-openstreet-map__route-link">
									<f:if condition="{routeLinkText}">
										<f:then>{routeLinkText}</f:then>
										<f:else>Route berechnen</f:else>
									</f:if>
								</a>
							</f:then>
						</f:if>
					</f:if>
				</div>
			</div>

			<!-- Loading Indicator -->
			<div class="content-openstreet-map__loading" data-openstreetmap-content-target="loading" role="status" aria-live="polite" style="display: none;">
				<div class="content-openstreet-map__loading-spinner" aria-hidden="true">⏳</div>
				<p class="content-openstreet-map__loading-text">Karte wird geladen...</p>
			</div>

			<!-- Error Message -->
			<div class="content-openstreet-map__error" data-openstreetmap-content-target="error" style="display: none;" role="alert" aria-live="assertive">
				<div class="content-openstreet-map__error-icon" aria-hidden="true">⚠️</div>
				<p class="content-openstreet-map__error-text">
					Beim Laden der Karte ist ein Fehler aufgetreten.
				</p>
			</div>
		</div>

		<!-- WCAG 1.1.1 (Non-text Content) Level A - Address always visible as text alternative -->
		<div class="visually-hidden" aria-hidden="true">
			<f:if condition="{title}">
				<h3>{title}</h3>
			</f:if>
			<address>
				{street}, {zip} {city}
			</address>
		</div>
	</f:section>
</div>
